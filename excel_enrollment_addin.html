<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enrollment Data Processor</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .logo {
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 28px;
            letter-spacing: 2px;
        }
        
        .logo-united {
            color: #0078d4;
        }
        
        .logo-enroll {
            color: #106ebe;
        }
        
        h1 {
            color: #0078d4;
            text-align: center;
            margin-bottom: 30px;
            font-size: 20px;
        }
        
        .date-input-section {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #0078d4;
        }
        
        .date-input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
        }
        
        .date-input-section input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .date-input-section .help-text {
            margin-top: 5px;
            font-size: 12px;
            color: #6c757d;
        }
        
        .button {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: background-color 0.3s;
        }
        
        .button:hover {
            background-color: #106ebe;
        }
        
        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .button.step1 {
            background-color: #28a745;
        }
        
        .button.step1:hover {
            background-color: #218838;
        }
        
        .button.step2 {
            background-color: #0078d4;
        }
        
        .button.step2:hover {
            background-color: #106ebe;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .field-selection {
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }
        
        .field-group {
            margin-bottom: 20px;
        }
        
        .field-group h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 16px;
        }
        
        .field-checkbox {
            margin: 8px 0;
            display: flex;
            align-items: center;
        }
        
        .field-checkbox input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }
        
        .field-checkbox label {
            cursor: pointer;
            user-select: none;
            color: #495057;
        }
        
        .field-checkbox.highlighted {
            background-color: #fff3cd;
            padding: 5px;
            border-radius: 4px;
            border-left: 4px solid #ffc107;
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #0078d4;
            width: 0%;
            transition: width 0.3s;
        }
        
        .step-indicator {
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
            color: #6c757d;
        }
        
        .step {
            display: inline-block;
            padding: 5px 10px;
            margin: 0 5px;
            border-radius: 15px;
            background-color: #e9ecef;
        }
        
        .step.active {
            background-color: #0078d4;
            color: white;
        }
        
        .step.completed {
            background-color: #28a745;
            color: white;
        }
        
        .date-info {
            margin: 10px 0;
            padding: 10px;
            background-color: #e3f2fd;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .zero-null-info {
            margin: 10px 0;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 4px;
            font-size: 12px;
            border-left: 4px solid #ffc107;
        }
        
        .debug-info {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 11px;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <span class="logo-united">UNITED</span>
            <span class="logo-enroll">ENROLL</span>
        </div>
        <h1>Enrollment Data Processor</h1>
        
        <div class="date-input-section">
            <label for="policyDate">Policy Change Date:</label>
            <input type="date" id="policyDate" required>
            <div class="help-text">Select the specific date when policy changes occurred</div>
        </div>
        
        <div class="step-indicator">
            <span class="step" id="step1Indicator">1</span>
            <span class="step" id="step2Indicator">2</span>
        </div>
        
        <button class="button step1" id="analyzeBtn" onclick="analyzeCurrentSheet()">
            Step 1: Analyze
        </button>
        
        <div id="fieldSelection" class="field-selection">
            <div class="field-group">
                <h3>SSN Fields Found:</h3>
                <div id="ssnFieldCheckboxes"></div>
                <div class="date-info">
                    <strong>Note:</strong> Only one SSN field should be selected.
                </div>
            </div>
            
            <div class="field-group">
                <h3>Cost Fields Found:</h3>
                <div id="costFieldCheckboxes"></div>
                <div class="date-info">
                    <strong>Note:</strong> Select fields containing enrollment costs to sum.
                </div>
            </div>
            
            <div id="dateFieldsInfo" class="date-info">
                <strong>Date Fields:</strong> <span id="dateFieldsList"></span>
            </div>
            
            <div class="zero-null-info">
                <strong>Logic:</strong> Consolidates multiple SSN rows into one unique row with cost summation.
            </div>
        </div>
        
        <button class="button step2" id="processBtn" onclick="processEnrollmentData()" disabled>
            Step 2: Process
        </button>
        
        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <div id="debugInfo" class="debug-info" style="display: none;"></div>
    </div>

    <script>
        // Global variables
        var detectedHeaders = [];
        var currentSheetData = [];
        var selectedSSNFields = [];
        var selectedCostFields = [];
        var detectedDateFields = [];
        var detectedCostFields = [];
        var policyChangeDate = null;
        var debugMode = false;

        // Initialize when Office is ready
        Office.onReady(function() {
            console.log('Add-in initialized');
            debugLog('Add-in initialized successfully');
            updateStepIndicators('none');
            
            // Set today's date as default
            var today = new Date();
            document.getElementById('policyDate').value = today.toISOString().split('T')[0];
            
            // Enable debug mode if URL parameter is set
            var urlParams = new URLSearchParams(window.location.search);
            debugMode = urlParams.get('debug') === 'true';
            if (debugMode) {
                document.getElementById('debugInfo').style.display = 'block';
                debugLog('Debug mode enabled');
            }
        });

        function debugLog(message) {
            var timestamp = new Date().toLocaleTimeString();
            console.log('[' + timestamp + '] ' + message);
            
            if (debugMode) {
                var debugDiv = document.getElementById('debugInfo');
                debugDiv.innerHTML += '<div>[' + timestamp + '] ' + message + '</div>';
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }

        function updateStepIndicators(currentStep) {
            var step1 = document.getElementById('step1Indicator');
            var step2 = document.getElementById('step2Indicator');
            
            // Reset classes
            step1.className = 'step';
            step2.className = 'step';
            
            if (currentStep === 'analyze') {
                step1.className = 'step active';
            } else if (currentStep === 'process') {
                step1.className = 'step completed';
                step2.className = 'step active';
            } else if (currentStep === 'completed') {
                step1.className = 'step completed';
                step2.className = 'step completed';
            }
        }

        function showStatus(message, type) {
            type = type || 'info';
            var statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            statusDiv.style.display = 'block';
            debugLog('Status: ' + type.toUpperCase() + ' - ' + message);
        }

        function updateProgress(percentage) {
            var progressContainer = document.getElementById('progressContainer');
            var progressBar = document.getElementById('progressBar');
            
            if (percentage > 0) {
                progressContainer.style.display = 'block';
                progressBar.style.width = percentage + '%';
            } else {
                progressContainer.style.display = 'none';
            }
        }

        function detectFields(headers) {
            var ssnFields = [];
            var dateFields = [];
            var costFields = [];
            
            for (var i = 0; i < headers.length; i++) {
                var header = headers[i];
                if (typeof header === 'string') {
                    var headerLower = header.toLowerCase();
                    
                    // Detect SSN fields
                    if (headerLower.includes('ssn') || 
                        headerLower.includes('social security') ||
                        headerLower.includes('employee ssn')) {
                        ssnFields.push({ name: header, index: i });
                    }
                    
                    // Detect date fields
                    if (headerLower.includes('date') || 
                        headerLower.includes('dob') ||
                        headerLower.includes('enrolled') ||
                        headerLower.includes('hire') ||
                        headerLower.includes('start') ||
                        headerLower.includes('effective') ||
                        headerLower.includes('created') ||
                        headerLower.includes('modified')) {
                        dateFields.push({ name: header, index: i });
                    }
                    
                    // Detect cost fields
                    if (headerLower.includes('cost') || 
                        headerLower.includes('amount') ||
                        headerLower.includes('fee') ||
                        headerLower.includes('price') ||
                        headerLower.includes('premium') ||
                        headerLower.includes('enrollment')) {
                        costFields.push({ name: header, index: i });
                    }
                }
            }
            
            debugLog('Detected ' + ssnFields.length + ' SSN fields, ' + dateFields.length + ' date fields, ' + costFields.length + ' cost fields');
            return { ssnFields: ssnFields, dateFields: dateFields, costFields: costFields };
        }

        function createFieldCheckboxes(fields, containerId, fieldType) {
            var container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (fields.length === 0) {
                container.innerHTML = '<div style="color: #6c757d; font-style: italic;">No ' + fieldType + ' fields detected</div>';
                return;
            }
            
            for (var i = 0; i < fields.length; i++) {
                var field = fields[i];
                var checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'field-checkbox highlighted';
                
                var checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = fieldType + '_' + i;
                checkbox.value = field.name;
                checkbox.checked = (fieldType === 'ssn' && i === 0); // Only check first SSN field by default
                checkbox.addEventListener('change', updateSelectedFields);
                
                var label = document.createElement('label');
                label.htmlFor = fieldType + '_' + i;
                label.textContent = field.name;
                
                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                container.appendChild(checkboxDiv);
            }
        }

        function updateSelectedFields() {
            selectedSSNFields = [];
            selectedCostFields = [];
            
            // Get selected SSN fields
            var ssnCheckboxes = document.querySelectorAll('#ssnFieldCheckboxes input[type="checkbox"]:checked');
            for (var i = 0; i < ssnCheckboxes.length; i++) {
                selectedSSNFields.push(ssnCheckboxes[i].value);
            }
            
            // Get selected cost fields
            var costCheckboxes = document.querySelectorAll('#costFieldCheckboxes input[type="checkbox"]:checked');
            for (var i = 0; i < costCheckboxes.length; i++) {
                selectedCostFields.push(costCheckboxes[i].value);
            }
            
            // Validate selection
            var processBtn = document.getElementById('processBtn');
            if (selectedSSNFields.length === 1) {
                processBtn.disabled = false;
                var message = 'Ready to process with SSN field: ' + selectedSSNFields[0];
                if (selectedCostFields.length > 0) {
                    message += ' and ' + selectedCostFields.length + ' cost field(s)';
                }
                showStatus(message, 'success');
            } else if (selectedSSNFields.length === 0) {
                processBtn.disabled = true;
                showStatus('Please select exactly one SSN field to continue', 'error');
            } else {
                processBtn.disabled = true;
                showStatus('Please select only one SSN field. Multiple SSN fields are not supported.', 'error');
            }
        }

        function analyzeCurrentSheet() {
            try {
                // Validate date input
                var dateInput = document.getElementById('policyDate');
                if (!dateInput.value) {
                    showStatus('Please select a policy change date first', 'error');
                    return;
                }
                
                policyChangeDate = new Date(dateInput.value);
                debugLog('Policy change date set to: ' + policyChangeDate.toLocaleDateString());
                
                updateStepIndicators('analyze');
                showStatus('Analyzing current sheet...', 'info');
                updateProgress(25);
                
                var analyzeBtn = document.getElementById('analyzeBtn');
                analyzeBtn.disabled = true;
                
                Excel.run(function(context) {
                    var worksheet = context.workbook.worksheets.getActiveWorksheet();
                    var usedRange = worksheet.getUsedRange();
                    
                    if (!usedRange) {
                        showStatus('No data found in the current sheet', 'error');
                        return Promise.resolve();
                    }
                    
                    usedRange.load("values");
                    return context.sync().then(function() {
                        var data = usedRange.values;
                        if (data.length === 0) {
                            showStatus('No data found in the current sheet', 'error');
                            return;
                        }
                        
                        updateProgress(50);
                        
                        // Store data for later processing
                        currentSheetData = data;
                        detectedHeaders = data[0];
                        debugLog('Loaded ' + data.length + ' rows with ' + detectedHeaders.length + ' columns');
                        
                        // Analyze headers
                        var fieldResults = detectFields(detectedHeaders);
                        detectedDateFields = fieldResults.dateFields;
                        detectedCostFields = fieldResults.costFields;
                        
                        updateProgress(75);
                        
                        // Create field selection interface
                        createFieldCheckboxes(fieldResults.ssnFields, 'ssnFieldCheckboxes', 'ssn');
                        createFieldCheckboxes(fieldResults.costFields, 'costFieldCheckboxes', 'cost');
                        
                        var dateFieldsList = document.getElementById('dateFieldsList');
                        dateFieldsList.textContent = fieldResults.dateFields.length > 0 ? 
                            fieldResults.dateFields.map(function(f) { return f.name; }).join(', ') : 
                            'None detected';
                        
                        // Show field selection
                        document.getElementById('fieldSelection').style.display = 'block';
                        
                        // Initialize selected fields
                        updateSelectedFields();
                        
                        updateProgress(100);
                        setTimeout(function() { updateProgress(0); }, 1000);
                    });
                }).then(function() {
                    analyzeBtn.disabled = false;
                }).catch(function(error) {
                    showStatus('Error analyzing sheet: ' + error.message, 'error');
                    debugLog('Analysis error: ' + error.message);
                    updateProgress(0);
                    analyzeBtn.disabled = false;
                });
                
            } catch (error) {
                showStatus('Error analyzing sheet: ' + error.message, 'error');
                debugLog('Analysis error: ' + error.message);
                updateProgress(0);
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        function isDateMatch(dateValue, targetDate) {
            if (!dateValue || !targetDate) return false;
            
            var date;
            if (typeof dateValue === 'string') {
                date = new Date(dateValue);
            } else if (typeof dateValue === 'number') {
                // Excel serial date number
                date = new Date((dateValue - 25569) * 86400 * 1000);
            } else if (dateValue instanceof Date) {
                date = dateValue;
            } else {
                return false;
            }
            
            if (isNaN(date.getTime())) return false;
            
            // Compare only the date part (ignore time)
            return date.toDateString() === targetDate.toDateString();
        }

        function isZeroOrNull(value) {
            return value === null || 
                   value === undefined || 
                   value === '' || 
                   value === 0 || 
                   (typeof value === 'string' && value.trim() === '') ||
                   (typeof value === 'string' && value.trim() === '0');
        }

        function formatSSN(ssn) {
            if (!ssn) return '';
            
            // Handle different SSN formats and preserve as string
            var ssnStr = ssn.toString().replace(/\D/g, '');
            
            if (ssnStr.length === 9) {
                return ssnStr.substring(0, 3) + '-' + ssnStr.substring(3, 5) + '-' + ssnStr.substring(5);
            }
            
            return ssn.toString();
        }

        function isDollarValue(value, fieldName) {
            // Check if this field is selected as a cost field
            if (selectedCostFields.indexOf(fieldName) === -1) {
                return false;
            }
            
            if (typeof value !== 'number') {
                // Try to parse as number if it's a string
                if (typeof value === 'string') {
                    var cleanValue = value.replace(/[$,]/g, '');
                    var parsed = parseFloat(cleanValue);
                    if (!isNaN(parsed)) {
                        value = parsed;
                    } else {
                        return false;
                    }
                } else {
                    return false;
                }
            }
            return value >= 0 && value < 50000; // Reasonable range for enrollment costs
        }

        function processDataBySSN(data, headers, ssnField, dateFields, targetDate) {
            var ssnGroups = {};
            var consolidatedRows = [];
            var dateMatchCount = 0;
            var zeroNullMatchCount = 0;
            var matchingSSNs = new Set();
            
            // Find SSN column index
            var ssnIndex = headers.indexOf(ssnField);
            if (ssnIndex === -1) {
                throw new Error('SSN field "' + ssnField + '" not found in headers');
            }
            
            debugLog('Processing ' + (data.length - 1) + ' data rows (excluding header)');
            
            // First pass: Find all SSNs that have matching dates or zero/null values
            for (var i = 1; i < data.length; i++) {
                var row = data[i];
                var ssn = formatSSN(row[ssnIndex]);
                if (!ssn) continue;
                
                // Check if any date field matches the target date OR is zero/null
                var hasMatchingDate = false;
                var hasZeroOrNull = false;
                
                for (var j = 0; j < dateFields.length; j++) {
                    var dateField = dateFields[j];
                    var dateIndex = headers.indexOf(dateField.name);
                    if (dateIndex !== -1) {
                        var dateValue = row[dateIndex];
                        
                        // Check for exact date match
                        if (isDateMatch(dateValue, targetDate)) {
                            hasMatchingDate = true;
                            dateMatchCount++;
                            break;
                        }
                        
                        // Check for zero or null
                        if (isZeroOrNull(dateValue)) {
                            hasZeroOrNull = true;
                            zeroNullMatchCount++;
                        }
                    }
                }
                
                if (hasMatchingDate || hasZeroOrNull) {
                    matchingSSNs.add(ssn);
                }
            }
            
            debugLog('Found ' + matchingSSNs.size + ' SSNs with matching criteria');
            
            // Second pass: Collect ALL rows for matching SSNs
            for (var i = 1; i < data.length; i++) {
                var row = data[i];
                var ssn = formatSSN(row[ssnIndex]);
                if (!ssn) continue;
                
                // If this SSN had any matching dates, include ALL rows for this SSN
                if (matchingSSNs.has(ssn)) {
                    if (!ssnGroups[ssn]) {
                        ssnGroups[ssn] = [];
                    }
                    
                    var processedRow = {};
                    for (var k = 0; k < headers.length; k++) {
                        processedRow[headers[k]] = row[k];
                    }
                    
                    ssnGroups[ssn].push(processedRow);
                }
            }
            
            // Third pass: Consolidate rows by SSN into unique field data
            for (var ssn in ssnGroups) {
                var consolidatedRow = consolidateSSNRows(ssnGroups[ssn], headers);
                consolidatedRows.push(consolidatedRow);
            }
            
            debugLog('Consolidated ' + Object.keys(ssnGroups).length + ' SSNs into ' + consolidatedRows.length + ' unique rows');
            debugLog('Found ' + dateMatchCount + ' date matches and ' + zeroNullMatchCount + ' zero/null matches');
            
            var originalRowCount = 0;
            for (var ssn in ssnGroups) {
                originalRowCount += ssnGroups[ssn].length;
            }
            
            return { 
                ssnGroups: ssnGroups, 
                matchingRows: consolidatedRows,
                originalRowCount: originalRowCount
            };
        }

        function consolidateSSNRows(rows, headers) {
            if (rows.length === 0) return {};
            if (rows.length === 1) return rows[0];
            
            var consolidatedRow = {};
            var sumTotals = {};
            var totalEnrollmentCost = 0;
            
            // Process each header/field
            for (var i = 0; i < headers.length; i++) {
                var header = headers[i];
                var values = [];
                
                for (var j = 0; j < rows.length; j++) {
                    var val = rows[j][header];
                    if (val !== null && val !== undefined && val !== '') {
                        values.push(val);
                    }
                }
                
                if (values.length === 0) {
                    consolidatedRow[header] = '';
                    continue;
                }
                
                // Check if this field contains dollar values that should be summed
                var dollarValues = [];
                for (var k = 0; k < values.length; k++) {
                    if (isDollarValue(values[k], header)) {
                        dollarValues.push(values[k]);
                    }
                }
                
                if (dollarValues.length > 0) {
                    var sum = 0;
                    for (var l = 0; l < dollarValues.length; l++) {
                        sum += parseFloat(dollarValues[l]);
                    }
                    sumTotals[header] = sum;
                    totalEnrollmentCost += sum;
                    consolidatedRow[header] = sum.toFixed(2);
                } else {
                    // Get unique values only
                    var uniqueValues = [];
                    for (var m = 0; m < values.length; m++) {
                        var stringVal = values[m] instanceof Date ? values[m].toLocaleDateString() : String(values[m]);
                        if (uniqueValues.indexOf(stringVal) === -1) {
                            uniqueValues.push(stringVal);
                        }
                    }
                    
                    if (uniqueValues.length === 1) {
                        consolidatedRow[header] = uniqueValues[0];
                    } else {
                        // Multiple unique values - combine them
                        consolidatedRow[header] = uniqueValues.join(' | ');
                    }
                }
            }
            
            // Add summary information
            consolidatedRow._isConsolidated = true;
            consolidatedRow._originalRowCount = rows.length;
            consolidatedRow._totalEnrollmentCost = totalEnrollmentCost;
            consolidatedRow._sumTotals = sumTotals;
            
            return consolidatedRow;
        }

        function getExcelColumnName(columnNumber) {
            var columnName = '';
            while (columnNumber > 0) {
                var remainder = (columnNumber - 1) % 26;
                columnName = String.fromCharCode(65 + remainder) + columnName;
                columnNumber = Math.floor((columnNumber - 1) / 26);
            }
            return columnName;
        }

        function processEnrollmentData() {
            try {
                updateStepIndicators('process');
                showStatus('Processing enrollment data...', 'info');
                updateProgress(10);
                
                var processBtn = document.getElementById('processBtn');
                var analyzeBtn = document.getElementById('analyzeBtn');
                processBtn.disabled = true;
                analyzeBtn.disabled = true;
                
                if (currentSheetData.length === 0) {
                    showStatus('No data to process. Please run Step 1: Analyze first.', 'error');
                    return;
                }
                
                if (selectedSSNFields.length !== 1) {
                    showStatus('Please select exactly one SSN field.', 'error');
                    return;
                }
                
                if (!policyChangeDate) {
                    showStatus('Please select a policy change date.', 'error');
                    return;
                }
                
                debugLog('Starting data processing...');
                
                Excel.run(function(context) {
                    updateProgress(25);
                    
                    // Process data
                    var processedData = processDataBySSN(
                        currentSheetData, 
                        detectedHeaders, 
                        selectedSSNFields[0], 
                        detectedDateFields, 
                        policyChangeDate
                    );
                    
                    updateProgress(50);
                    debugLog('Processed data: ' + processedData.matchingRows.length + ' matching rows, ' + Object.keys(processedData.ssnGroups).length + ' unique SSNs');
                    
                    // Create policy changes sheet
                    return createPolicyChangesSheet(context, processedData.ssnGroups, detectedHeaders).then(function() {
                        updateProgress(90);
                        updateStepIndicators('completed');
                        showStatus('Processing complete! Found ' + processedData.matchingRows.length + ' matching records across ' + Object.keys(processedData.ssnGroups).length + ' unique SSNs.', 'success');
                        updateProgress(100);
                        setTimeout(function() { updateProgress(0); }, 1000);
                    });
                }).catch(function(error) {
                    showStatus('Error processing data: ' + error.message, 'error');
                    debugLog('Processing error: ' + error.message);
                    updateProgress(0);
                }).finally(function() {
                    processBtn.disabled = false;
                    analyzeBtn.disabled = false;
                });
                
            } catch (error) {
                showStatus('Error processing data: ' + error.message, 'error');
                debugLog('Processing error: ' + error.message);
                updateProgress(0);
                document.getElementById('processBtn').disabled = false;
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        function createPolicyChangesSheet(context, ssnGroups, originalHeaders) {
            try {
                debugLog('Starting policy changes sheet creation...');
                
                // Step 1: Delete existing sheet if present
                var worksheets = context.workbook.worksheets;
                var sheetName = "Policy Changes to Note";
                
                var existingSheet = worksheets.getItemOrNullObject(sheetName);
                return context.sync().then(function() {
                    if (!existingSheet.isNullObject) {
                        existingSheet.delete();
                        debugLog('Deleted existing policy changes sheet');
                    }
                    return context.sync();
                }).then(function() {
                    // Step 2: Create new sheet
                    var newSheet = worksheets.add(sheetName);
                    return context.sync().then(function() {
                        debugLog('New policy changes sheet created');
                        
                        // Step 3: Handle empty data case
                        if (Object.keys(ssnGroups).length === 0) {
                            var noDataRange = newSheet.getRange("A1");
                            noDataRange.values = [["No policy changes found for the specified date or zero/null values"]];
                            noDataRange.format.font.bold = true;
                            return context.sync().then(function() {
                                debugLog('No data to write - created empty sheet message');
                            });
                        }
                        
                        // Step 4: Create enhanced headers with summary columns
                        var enhancedHeaders = originalHeaders.slice(); // Copy array
                        enhancedHeaders.push('CONSOLIDATED_ROWS');
                        enhancedHeaders.push('TOTAL_ENROLLMENT_COST');
                        enhancedHeaders.push('CONSOLIDATION_NOTES');
                        
                        // Write headers
                        var headerRange = newSheet.getRange('A1:' + getExcelColumnName(enhancedHeaders.length) + '1');
                        headerRange.values = [enhancedHeaders];
                        headerRange.format.font.bold = true;
                        headerRange.format.fill.color = "#0078d4";
                        headerRange.format.font.color = "white";
                        
                        return context.sync().then(function() {
                            debugLog('Enhanced headers written successfully');
                            
                            var currentRow = 2;
                            var totalRowsWritten = 0;
                            var consolidatedData = [];
                            
                            // Step 5: Process consolidated data (one row per SSN)
                            for (var ssn in ssnGroups) {
                                var rows = ssnGroups[ssn];
                                var consolidatedRow = consolidateSSNRows(rows, originalHeaders);
                                consolidatedData.push({
                                    ssn: ssn,
                                    data: consolidatedRow,
                                    originalRows: rows
                                });
                            }
                            
                            debugLog('Processing ' + consolidatedData.length + ' consolidated SSN entries');
                            
                            // Step 6: Write data in chunks to avoid memory issues
                            var chunkSize = 10;
                            var chunks = [];
                            for (var i = 0; i < consolidatedData.length; i += chunkSize) {
                                chunks.push(consolidatedData.slice(i, i + chunkSize));
                            }
                            
                            function writeNextChunk(chunkIndex) {
                                if (chunkIndex >= chunks.length) {
                                    // All chunks written, finish up
                                    return finishSheet();
                                }
                                
                                var chunk = chunks[chunkIndex];
                                var chunkData = [];
                                
                                for (var j = 0; j < chunk.length; j++) {
                                    var entry = chunk[j];
                                    var data = entry.data;
                                    
                                    // Prepare row data for all original headers
                                    var rowData = [];
                                    for (var k = 0; k < originalHeaders.length; k++) {
                                        var header = originalHeaders[k];
                                        var value = data[header];
                                        rowData.push((value !== undefined && value !== null) ? value : '');
                                    }
                                    
                                    // Add summary columns
                                    rowData.push(data._originalRowCount || 1);
                                    rowData.push(data._totalEnrollmentCost ? data._totalEnrollmentCost.toFixed(2) : '0.00');
                                    
                                    // Create consolidation notes
                                    var notes = '';
                                    if (data._originalRowCount > 1) {
                                        notes = 'Consolidated ' + data._originalRowCount + ' rows. ';
                                        if (data._sumTotals && Object.keys(data._sumTotals).length > 0) {
                                            var sumDetails = [];
                                            for (var field in data._sumTotals) {
                                                sumDetails.push(field + ': ' + data._sumTotals[field].toFixed(2));
                                            }
                                            notes += 'Sums: ' + sumDetails.join(', ');
                                        }
                                    } else {
                                        notes = 'Single row - no consolidation needed';
                                    }
                                    rowData.push(notes);
                                    
                                    chunkData.push(rowData);
                                }
                                
                                // Write the chunk
                                var startRow = currentRow;
                                var endRow = currentRow + chunkData.length - 1;
                                var chunkRange = newSheet.getRange('A' + startRow + ':' + getExcelColumnName(enhancedHeaders.length) + endRow);
                                chunkRange.values = chunkData;
                                
                                // Apply formatting for consolidated rows
                                for (var m = 0; m < chunk.length; m++) {
                                    var entry = chunk[m];
                                    if (entry.data._originalRowCount > 1) {
                                        var rowNum = startRow + m;
                                        var rowRange = newSheet.getRange('A' + rowNum + ':' + getExcelColumnName(enhancedHeaders.length) + rowNum);
                                        rowRange.format.fill.color = "#E3F2FD";
                                        
                                        // Highlight cost total
                                        var costTotalRange = newSheet.getRange(getExcelColumnName(enhancedHeaders.length - 1) + rowNum);
                                        costTotalRange.format.font.bold = true;
                                        costTotalRange.format.fill.color = "#FFEB3B";
                                    }
                                }
                                
                                currentRow += chunkData.length;
                                totalRowsWritten += chunkData.length;
                                
                                return context.sync().then(function() {
                                    debugLog('Wrote chunk ' + (chunkIndex + 1) + ' of ' + chunks.length + ' (' + chunkData.length + ' rows)');
                                    return writeNextChunk(chunkIndex + 1);
                                });
                            }
                            
                            function finishSheet() {
                                // Step 7: Auto-fit columns
                                try {
                                    newSheet.getUsedRange().format.autofitColumns();
                                } catch (autofitError) {
                                    debugLog('Auto-fit failed, continuing anyway: ' + autofitError.message);
                                }
                                
                                // Step 8: Add summary section
                                var summaryStartRow = currentRow + 2;
                                var summaryData = [
                                    ['PROCESSING SUMMARY', ''],
                                    ['Total Unique SSNs:', Object.keys(ssnGroups).length],
                                    ['Total Original Rows:', Object.keys(ssnGroups).reduce(function(sum, ssn) { return sum + ssnGroups[ssn].length; }, 0)],
                                    ['Total Consolidated Rows:', totalRowsWritten],
                                    ['Processing Date:', new Date().toLocaleDateString()],
                                    ['Processing Time:', new Date().toLocaleTimeString()]
                                ];
                                
                                var summaryRange = newSheet.getRange('A' + summaryStartRow + ':B' + (summaryStartRow + summaryData.length - 1));
                                summaryRange.values = summaryData;
                                
                                // Format summary header
                                var summaryHeaderRange = newSheet.getRange('A' + summaryStartRow + ':B' + summaryStartRow);
                                summaryHeaderRange.format.font.bold = true;
                                summaryHeaderRange.format.fill.color = "#4CAF50";
                                summaryHeaderRange.format.font.color = "white";
                                
                                // Step 9: Activate the new sheet
                                newSheet.activate();
                                
                                return context.sync().then(function() {
                                    debugLog('Policy changes sheet completed with ' + totalRowsWritten + ' rows');
                                });
                            }
                            
                            // Start writing chunks
                            return writeNextChunk(0);
                        });
                    });
                });
                
            } catch (error) {
                debugLog('Policy changes sheet creation failed: ' + error.message);
                console.error('Policy changes sheet creation error:', error);
                throw error;
            }
        }
    </script>
</body>
</html>